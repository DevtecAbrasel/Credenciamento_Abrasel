<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Mapa de mesas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link rel="stylesheet" href="styles\style-mapa-de-mesas.css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>

<body>
  <canvas class="orb-canvas"></canvas>

  <div class="overlay">
    <div class="controls">
      <!-- Adicionado um ID ao input para facilitar a seleção no JavaScript -->
      <input placeholder="Adicione os convidados aqui (Use vírgula para separar)" type="text" id="guest_names">
      <button id="add_guests" class="guest_names" for="guest_names">Add convidado</button>
      <button id="table">Add Mesa</button>
      <button id="generateImage" class="overlay__btn overlay__btn--colors">Baixar imagem</button>
    </div>

    <ul id="sortable" class="guests"></ul>

    <div id="tables">
      <!-- O conteúdo da tabela será preenchido dinamicamente pelo JavaScript -->
    </div>

    <div class="export_area">
      <textarea id="export_text"></textarea>
      <br style="clear:both">
    </div>
  </div>

  <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
  <script src='https://code.jquery.com/ui/1.11.0/jquery-ui.js'></script>
  <script src="mapa-de-mesas.js"></script>
  <script type="module" src="mapa-de-mesas.js"></script>
  <!-- Adicionado o script para buscar os eventos da API -->
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      try {
        const events = await fetchEvents();
        console.log("Eventos recebidos:", events);
        updateCheckboxes(events);
      } catch (error) {
        console.error("Erro durante a obtenção de eventos:", error.message);
      }
    });

    async function fetchEvents() {
      const apiUrl = "http://localhost:8080/v1/invitee";

      try {
        const response = await fetch(apiUrl, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        });

        if (!response.ok) {
          throw new Error(`Erro na requisição: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Erro durante a solicitação fetch:", error.message);
        throw error;
      }
    }

    function updateCheckboxes(events) {
      const checkboxContainer = document.getElementById("sortable");

      // Limpa o container antes de adicionar os novos checkboxes
      checkboxContainer.innerHTML = "";

      events.forEach((invitee, index) => {
        // Cria um novo checkbox para cada evento
        const checkbox = document.createElement("li");
        checkbox.innerHTML = `<div contenteditable='true'>${invitee.name}</div><span>x</span>`;

        // Adiciona o checkbox ao container
        checkboxContainer.appendChild(checkbox);
      });

      // Chama a função para tornar os itens arrastáveis após atualizar os checkboxes
      start_drag();
    }

    document.getElementById("generateImage").addEventListener("click", function () {
      generateImageAndDownload();
    });

    function generateImageAndDownload() {
      const container = document.querySelector(".overlay");

      html2canvas(container).then(function (canvas) {
        // Cria um link para baixar a imagem
        const link = document.createElement("a");
        link.href = canvas.toDataURL();
        link.download = "mapa-de-mesas.png";

        // Adiciona o link ao corpo da página e simula um clique para iniciar o download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }
  </script>
</body>

</html>
